<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>Mike's Journey</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.js'></script>
<link href='https://api.mapbox.com/mapbox.js/v2.4.0/mapbox.css' rel='stylesheet' />
<link href='https://fonts.googleapis.com/css?family=Pirata+One' rel='stylesheet' type='text/css'>
<style>
  body { margin:0; padding:0; }
  #map { position:absolute; top:0; bottom:0; width:100%; }
  #days,
  #kms { 
  position:absolute; 
  right:0; 
  bottom:50px; 
  width:50%;  
  color: #634d24;
  text-align: right; 
  font-size: 3em;
	margin-right: 1em;  
  -webkit-text-stroke: 1px white;
  font-family: 'Pirata One', cursive;
  text-shadow:
       3px 3px 0 #FFF,
     -1px -1px 0 #FFF,  
      1px -1px 0 #FFF,
      -1px 1px 0 #FFF,
       1px 1px 0 #FFF;
  }
  #kms { top:50px; bottom: auto; width:50%;}
</style>
</head>
<body>
<div id='map'></div>
<div id='days'>Day 1</div>
<div id='kms'>0km Walked</div>
<script>
//So much shame please forgive!
var lerpf = function(start, end, duration) {
	this.start = start || 0;
	this.end = end || 0;
	this.duration = duration || 5000;
	this._startTime = new Date().getTime();
	
	this.tick = function() {
		var elapsed = new Date().getTime() - this._startTime;
		if (elapsed >= this.duration) {
			return end;
		}
		var v = (this.duration - elapsed) / this.duration;
		return (this.start * v) + (this.end * (1-v));
	};
	
	return this;
};
var data = {
	"Saint Jean Pied de Port" : [43.1570065,-1.251297],
	"Roncesvalles" : [43.0092949,-1.3218817],
	"Larrasoana" : [42.9020177,-1.5464834],
	"Cizur Menor" : [42.786516,-1.677037],
	"Puente la Reina" : [42.672304,-1.813594],
	"Estella" : [42.672086,-2.032452],
	"Los Arcos" : [42.568487,-2.191654],
	"Viana" : [42.515448,-2.372724],
	"Navarrete" : [42.4290505,-2.5789358],
	"Najera" : [42.416741,-2.729462],
	"St Dom de la Calz" : [42.4363137,-2.9778535],
	"Belorado" : [42.4207062,-3.2073179],
	"San Juan de Ortega" : [42.3753488,-3.4381867],
	"Burgos" : [42.3441047,-3.7647326],
	"Hornillos del Camino" : [42.3388769,-3.9306895],
	"Castrojeriz" : [42.2897815,-4.1541518],
	"Fromista" : [42.26705,-4.4140027],
	"Carrion de los Condes" : [42.3409294,-4.6196845],
	"Terradillos de los Templarios" : [42.3630525,-4.8944402],
	"Bercianos del Real Camino" : [42.3874234,-5.1479934],
	"Mansilla de las Mulas" : [42.4946852,-5.4248565],
	"Leon" : [42.593614,-5.6524865],
	"Villadangos del Paramo" : [42.5173453,-5.7750853],
	"Astorga" : [42.4582654,-6.0894944],
	"Rabanal del Camino" : [42.4817279,-6.2878366],
	"Molinaseca" : [42.5375322,-6.5245702],
	"Cacabelos" : [42.5986808,-6.7423721],
	"Vega de Valcarce" : [42.6643365,-6.9542767],
	"Alto de Poyo" : [42.7120342,-7.1249255],
	"Calbor" : [42.7789647,-7.4290057],
	"Portomarin" : [42.8081689,-7.6251987],
	"Ponte Campana" : [42.8081689,-7.6251987],
	"Ribadiso, Spain" : [42.9382834,-8.1569251],
	"Arca do Pino" : [42.900209,-8.3831462],
	"Santiago de Compostela" : [42.8801996,-8.579789],	
};

var delay = 60;
var zoom = 10;
var duration = 60;
var kms = 800;
var days = 31;
var curPoint = 0;

function first(obj) {
    for (var a in obj) return a;
}

L.mapbox.accessToken = 'pk.eyJ1IjoibWFkZWJ5bWlrZSIsImEiOiJsRmJ2WTFvIn0.vAjq0NGB6sn-6gy48wGH2Q';

var map = L.mapbox.map('map', 'mapbox.pirates');

var polyline = L.polyline([]).addTo(map);
var currentPos = [0,0];
 
function beginJourney(){

	var keys = [];
	var points = [];
	for (var key in data) {
		// skip loop if the property is from prototype
		if (!data.hasOwnProperty(key)) continue;
		keys.push(key);
		points.push(data[key]);
	}
	var leg = function(){
		
		document.querySelector('#days').innerHTML = "Day " + Math.round(days/points.length * curPoint);
		document.querySelector('#kms').innerHTML = Math.round(kms/points.length * curPoint) + "km Walked";
		
		
		if(curPoint==0){
			add(points[curPoint]);
			mark(points[curPoint], keys[curPoint]);
			window.setTimeout(leg, delay*6);
		}else if (curPoint < points.length-1){
			window.setTimeout(function(){
				animTo(points[curPoint],function(){
					mark(points[curPoint], keys[curPoint]);
					leg();
				})
			}, delay);
		} else { // Hacky
			curPoint++;
			document.querySelector('#days').innerHTML = "Day " + Math.round(days/points.length * curPoint);
			document.querySelector('#kms').innerHTML = Math.round(kms/points.length * curPoint) + "km Walked";
		}
		
		curPoint++;
	}
	leg();
}

function add(point) {
    polyline.addLatLng(
        L.latLng(point)
	);
    map.setView(point, zoom);
	currentPos = point;
}
function mark(pos,title){
	//ToDO
	L.marker(new L.LatLng(pos[0],pos[1]), {
		icon: L.mapbox.marker.icon({
			'marker-color': '7a653c'
		})
	}).bindPopup(title).addTo(map);
}
function animTo(point, cb){
	var lerpLat = new lerpf(currentPos[0],point[0], duration);
	var lerpLon = new lerpf(currentPos[1],point[1], duration);
	var animate = function (){
		var v1 = lerpLat.tick();
		var v2 = lerpLon.tick();
		add([v1,v2]);
		if(v1 !== lerpLat.end){
			window.setTimeout(animate, 100);	
		}else{
			cb();
		}
	}
	animate();
}
//ToDo: fix
map.on("zoom", function(e) {
  console.log("Current map zoom is: ", map.zoom());
  zoom = map.zoom();
});

beginJourney();
</script>
</body>
</html>